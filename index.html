<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é™ï¼Œç»™ä½ çš„ä¸€å°ä¿¡</title>
  <meta name="description" content="æƒ…äººèŠ‚æƒ…ä¹¦ï¼ˆæˆç†Ÿæ¸©æŸ”ç‰ˆï¼‰" />

  <style>
    :root{
      --bg1:#0f1020;
      --bg2:#1b1630;
      --text:#f6f2ff;
      --muted:#d8cfffcc;
      --stroke:#ffffff1a;
      --card:#ffffff10;
      --accent:#ff6b9a;
      --accent2:#ffd1dc;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 28px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei","Noto Sans SC",system-ui,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,107,154,.18), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(255,209,220,.14), transparent 60%),
        radial-gradient(1100px 900px at 50% 90%, rgba(130,140,255,.10), transparent 60%),
        linear-gradient(140deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Photo background layer */
    .photo-bg{
      position:fixed; inset:0;
      background-image: url("photo.jpg");
      background-size: cover;
      background-position: center;
      opacity:.15;
      filter: blur(2px) saturate(1.05);
      transform: scale(1.06);
      pointer-events:none;
    }
    .photo-vignette{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 700px at 50% 30%, transparent 30%, rgba(0,0,0,.45) 75%),
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      pointer-events:none;
    }

    /* subtle grain */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.20'/%3E%3C/svg%3E");
      opacity:.08;
      mix-blend-mode:overlay;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:32px 18px;
      position:relative;
      z-index:1;
    }

    /* ===== Scene ===== */
    .scene{
      width:min(980px, 100%);
      display:grid;
      place-items:center;
      gap:18px;
    }

    .hint{
      color:rgba(216,207,255,.80);
      font-size:14px;
      text-align:center;
      line-height:1.7;
      transition: opacity 500ms ease, transform 500ms ease;
    }

    /* ===== Envelope ===== */
    .envelope-wrap{
      width:min(560px, 92vw);
      aspect-ratio: 16 / 10;
      position:relative;
      display:grid;
      place-items:center;
      user-select:none;
      cursor:pointer;
      perspective: 1200px;
      outline:none;
    }
    .envelope{
      width:100%;
      height:100%;
      position:relative;
      transform-style:preserve-3d;
      filter: drop-shadow(0 24px 50px rgba(0,0,0,.45));
    }
    .env-body{
      position:absolute; inset:0;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      overflow:hidden;
    }
    .env-body:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(420px 190px at 25% 20%, rgba(255,107,154,.16), transparent 60%),
        radial-gradient(460px 220px at 80% 25%, rgba(255,209,220,.14), transparent 65%);
      opacity:.9;
    }
    .fold-left, .fold-right, .fold-bottom{ position:absolute; inset:0; z-index:2; }
    .fold-left:before{
      content:"";
      position:absolute; inset:0;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      clip-path: polygon(0 0, 55% 50%, 0 100%);
      border-radius:18px;
    }
    .fold-right:before{
      content:"";
      position:absolute; inset:0;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      clip-path: polygon(100% 0, 45% 50%, 100% 100%);
      border-radius:18px;
    }
    .fold-bottom:before{
      content:"";
      position:absolute; inset:0;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.10);
      clip-path: polygon(0 100%, 50% 40%, 100% 100%);
      border-radius:18px;
    }

    /* Top flap */
    .flap{
      position:absolute;
      left:0; right:0;
      top:-1px;
      height:56%;
      transform-origin: top center;
      transform: rotateX(0deg);
      transition: transform 900ms cubic-bezier(.2,.9,.2,1);
      z-index:6;
    }
    .flap:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      border-bottom:none;
      clip-path: polygon(0 0, 100% 0, 50% 100%);
      border-top-left-radius:18px;
      border-top-right-radius:18px;
    }

    /* Wax seal */
    .seal{
      position:absolute;
      width:86px; height:86px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.24), transparent 38%),
                  linear-gradient(135deg, rgba(255,107,154,.9), rgba(255,209,220,.55));
      box-shadow: 0 14px 30px rgba(255,107,154,.18);
      border:1px solid rgba(255,107,154,.35);
      display:grid;
      place-items:center;
      z-index:7;
      transform: translateY(14px);
      transition: transform 700ms cubic-bezier(.2,.9,.2,1), opacity 500ms ease;
    }
    .seal span{
      font-weight:900;
      color:#1b1020;
      letter-spacing:2px;
      opacity:.92;
    }

    /* ===== Paper: pull out then unfold ===== */
    .paper{
      position:absolute;
      width:92%;
      height:88%;
      left:4%;
      bottom:6%;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.16);
      z-index:4;
      overflow:hidden;
      transform: translateY(30%);
      transition: transform 900ms cubic-bezier(.2,.95,.2,1), opacity 600ms ease;
    }
    .paper:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(560px 260px at 20% 0%, rgba(255,107,154,.12), transparent 60%),
        radial-gradient(520px 240px at 85% 10%, rgba(255,209,220,.10), transparent 65%);
      opacity:.9;
      pointer-events:none;
    }

    .paper .paper-head{
      padding:16px 16px 8px;
      font-weight:900;
      letter-spacing:.8px;
      color:rgba(246,242,255,.92);
    }
    .paper .paper-line{
      padding:0 16px 8px;
      color:rgba(216,207,255,.82);
      font-size:13px;
      line-height:1.6;
    }

    /* Unfold panels */
    .paper-unfold{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-rows: 1fr 1fr;
      transform-origin: top center;
      transform: scaleY(.62);
      opacity:0;
      transition: opacity 600ms ease, transform 900ms cubic-bezier(.2,.95,.2,1);
    }
    .panel{
      border-top:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
      position:relative;
    }
    .panel:after{
      content:"";
      position:absolute; left:0; right:0; top:0; height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
      opacity:.6;
    }

    /* open sequence states */
    .state-flap .flap{ transform: rotateX(-165deg); }
    .state-flap .seal{ opacity:0; transform: translateY(40px) scale(.92); pointer-events:none; }

    .state-pull .paper{ transform: translateY(-18%); }

    .state-unfold .paper{
      height:120%;
      bottom:-8%;
      border-radius: 18px;
      transform: translateY(-30%);
    }
    .state-unfold .paper-head,
    .state-unfold .paper-line{ opacity:0; transition: opacity 400ms ease; }
    .state-unfold .paper-unfold{
      opacity:1;
      transform: scaleY(1);
    }

    /* ===== Letter Card ===== */
    .card{
      width:min(900px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(10px);

      transform: translateY(12px);
      opacity:0;
      pointer-events:none;
      transition: opacity 800ms ease, transform 800ms ease;
    }
    .card.show{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }
    .card:after{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(600px 240px at 20% 0%, rgba(255,107,154,.18), transparent 60%),
                  radial-gradient(500px 220px at 85% 10%, rgba(255,209,220,.14), transparent 65%);
      opacity:.7;
      pointer-events:none;
    }

    header{
      position:relative;
      padding:34px 34px 12px;
      z-index:1;
      display:flex;
      gap:18px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .kicker{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:8px 14px;
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      background:rgba(0,0,0,.15);
      font-size:13px;
      letter-spacing:.5px;
      color:var(--muted);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:linear-gradient(180deg, var(--accent), var(--accent2));
      box-shadow:0 0 18px rgba(255,107,154,.55);
    }

    h1{
      margin:0;
      font-size:clamp(22px, 3.4vw, 34px);
      line-height:1.25;
      font-weight:900;
      letter-spacing:.6px;
      flex:1 1 260px;
      padding-top:2px;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.7;
      width:100%;
    }

    /* Polaroid frame */
    .polaroid{
      width: 140px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 18px;
      padding:10px 10px 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      transform: rotate(-2.5deg);
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .polaroid:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(160px 120px at 20% 0%, rgba(255,107,154,.18), transparent 60%);
      opacity:.65;
      pointer-events:none;
    }
    .polaroid .img{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
    }
    .polaroid img{
      width:100%;
      height:100%;
      object-fit:cover;
      transform: scale(1.03);
      filter: saturate(1.06);
    }
    .polaroid .handwrite{
      margin-top:10px;
      padding:0 2px;
      font-size:14px;
      line-height:1.2;
      color: rgba(246,242,255,.88);
      font-family: "Bradley Hand", "Comic Sans MS", "Segoe Script", "Snell Roundhand", "PingFang SC", cursive;
      letter-spacing:.2px;
      opacity:.92;
      display:flex;
      justify-content:space-between;
      gap:10px;
      white-space:nowrap;
    }
    .polaroid .handwrite span:last-child{
      opacity:.85;
      font-size:13px;
    }

    main{
      position:relative;
      z-index:1;
      padding:14px 34px 34px;
    }
    .letter{
      padding:22px 22px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
    }
    .letter p{
      margin:0 0 14px;
      color: rgba(246,242,255,.92);
      font-size:16px;
      line-height:1.95;
      letter-spacing:.2px;
      text-wrap:pretty;
    }
    .letter p:last-child{margin-bottom:0}

    .signature{
      margin-top:18px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      color:var(--muted);
      font-size:14px;
    }
    .sig-name{
      font-weight:900;
      color:rgba(246,242,255,.92);
      letter-spacing:1px;
    }

    .actions{
      margin-top:18px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
    }
    button{
      appearance:none;
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      color:rgba(246,242,255,.95);
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size:14px;
    }
    button:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.14);
      border-color: rgba(255,255,255,.24);
    }
    button.primary{
      background: linear-gradient(135deg, rgba(255,107,154,.85), rgba(255,209,220,.55));
      border-color: rgba(255,107,154,.35);
      box-shadow: 0 10px 30px rgba(255,107,154,.22);
      color:#1b1020;
      font-weight:850;
    }
    button.primary:hover{ transform: translateY(-1px) scale(1.01); }

    .audio-pill{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      color:rgba(216,207,255,.85);
      font-size:13px;
    }
    .audio-pill b{ color:rgba(246,242,255,.92); font-weight:850; }

    footer{
      position:relative;
      z-index:1;
      padding:0 34px 26px;
      color:rgba(216,207,255,.7);
      font-size:12px;
      line-height:1.6;
    }

    /* Hearts */
    .hearts{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    .heart{
      position:absolute;
      width:12px;height:12px;
      transform: rotate(45deg);
      opacity:.0;
      animation: floatUp linear forwards;
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.25));
    }
    .heart:before,.heart:after{
      content:"";
      position:absolute;
      width:12px;height:12px;
      border-radius:50%;
      background: inherit;
    }
    .heart:before{ left:-6px; top:0;}
    .heart:after{ left:0; top:-6px;}
    @keyframes floatUp{
      0%{ transform: translateY(20px) rotate(45deg) scale(.9); opacity:0;}
      10%{opacity:.55}
      70%{opacity:.35}
      100%{ transform: translateY(-120vh) rotate(45deg) scale(1.15); opacity:0;}
    }

    @media (prefers-reduced-motion: reduce){
      .flap,.paper,.seal,.card,.paper-unfold{transition:none !important}
      .heart{display:none !important}
    }
  </style>
</head>

<body>
  <div class="photo-bg" aria-hidden="true"></div>
  <div class="photo-vignette" aria-hidden="true"></div>
  <div class="hearts" id="hearts" aria-hidden="true"></div>

  <div class="wrap">
    <div class="scene">

      <!-- Envelope -->
      <div class="envelope-wrap" id="envelopeWrap" role="button" tabindex="0" aria-label="æ‰“å¼€ä¿¡å°">
        <div class="envelope" id="envelope">
          <div class="env-body"></div>
          <div class="fold-left"></div>
          <div class="fold-right"></div>
          <div class="fold-bottom"></div>

          <div class="paper" id="paper">
            <div class="paper-head">é™ï¼Œè¿™æ˜¯ä¸€å°æ¥è‡ªæ„¿æ„ä¸ºä½ è€Œæ´»çš„äººçš„ä¿¡ã€‚</div>
            <div class="paper-line">è½»è§¦ä¿¡å°ï¼Œçº¸ä¼šè¢«æŠ½å‡ºæ¥ï¼Œç„¶åæ…¢æ…¢å±•å¼€ã€‚</div>
            <div class="paper-line" style="opacity:.85">ï¼ˆè‹¥éŸ³ä¹æ²¡å“ï¼Œç‚¹ä¸€ä¸‹é¡µé¢å³å¯ï¼‰</div>

            <!-- unfold effect -->
            <div class="paper-unfold" aria-hidden="true">
              <div class="panel"></div>
              <div class="panel"></div>
            </div>
          </div>

          <div class="flap"></div>
          <div class="seal"><span>OPEN</span></div>
        </div>
      </div>

      <div class="hint" id="hint">
        è½»è§¦/ç‚¹å‡»ä¿¡å°æ‰“å¼€ã€‚<br/>
        éŸ³ä¹ä¼šæ¸©æŸ”æ¸å…¥ï¼›å¦‚æœæµè§ˆå™¨æ‹¦æˆªè‡ªåŠ¨æ’­æ”¾ï¼Œç‚¹ä¸€ä¸‹â€œæ’­æ”¾éŸ³ä¹â€å³å¯ã€‚
      </div>

      <!-- Letter Card -->
      <article class="card" id="card" role="article" aria-label="æƒ…äººèŠ‚æƒ…ä¹¦">
        <header>
          <div class="polaroid" title="æˆ‘ä»¬çš„ç…§ç‰‡">
            <div class="img">
              <img src="photo.jpg" alt="photo" />
            </div>
            <div class="handwrite">
              <span>For é™</span>
              <span id="handDate"></span>
            </div>
          </div>

          <div class="kicker"><span class="dot"></span> Valentineâ€™s Day Letter</div>
          <h1>ç»™é™çš„ä¸€å°ä¿¡</h1>
          <p class="subtitle">é™ï¼Œè¿™æ˜¯ä¸€å°æ¥è‡ªæ„¿æ„ä¸ºä½ è€Œæ´»çš„äººçš„ä¿¡ã€‚</p>
        </header>

        <main>
          <section class="letter" id="letter">
            <p>é™ï¼Œ</p>

            <p>å…¶å®æˆ‘ä¸€ç›´è§‰å¾—ï¼Œæˆ‘ä»¬çš„æ„Ÿæƒ…å¾ˆç‰¹åˆ«ã€‚</p>

            <p>å®ƒä¸å¼ æ‰¬ï¼Œä¸è½°è½°çƒˆçƒˆï¼Œå´è®©æˆ‘åœ¨å¾ˆå¤šæ—¶åˆ»æ„Ÿåˆ°å®‰å¿ƒã€‚<br/>
            æ¯”å¦‚ä½ æå‰å»å®‰æ’å¥½ä½çš„åœ°æ–¹ï¼Œç„¶åæ¥æ¥æˆ‘ã€‚<br/>
            æ¯”å¦‚æˆ‘ä»¬ä¸€èµ·èƒ¡åƒæµ·å–ã€è°ˆå¤©è¯´åœ°ã€‚<br/>
            é‚£äº›ç”»é¢å¾ˆç®€å•ï¼Œå´è®©æˆ‘å¾ˆçæƒœã€‚</p>

            <p>å¼‚å›½çš„è·ç¦»ç¡®å®ä¸å®¹æ˜“ï¼Œä½†æ¯å¤©è§†é¢‘ã€èŠå¤©çš„é‚£äº›æ—¶é—´ï¼Œè®©æˆ‘è§‰å¾—æˆ‘ä»¬å¹¶ä¸æ˜¯åœ¨ä¸¤ä¸ªä¸–ç•Œé‡Œç”Ÿæ´»ã€‚</p>

            <p>ä½ æ›¾ç»è¯´ï¼Œå…ˆå¼‚å›½ä¸€å¹´ï¼Œçœ‹çœ‹æ„Ÿè§‰ã€‚<br/>
            æˆ‘å…¶å®æ˜¯å¼€å¿ƒçš„ã€‚<br/>
            å› ä¸ºé‚£ä»£è¡¨ä½ æ„¿æ„è®¤çœŸè€ƒè™‘æˆ‘ï¼Œè€Œä¸æ˜¯éšä¾¿å¯¹å¾…ã€‚</p>

            <p>æˆ‘ä¸çŸ¥é“æœªæ¥ä¼šæ€æ ·ï¼Œä½†æˆ‘çŸ¥é“æ­¤åˆ»çš„æˆ‘ï¼Œæ˜¯è®¤çœŸåœ°å–œæ¬¢ä½ ã€‚<br/>
            å–œæ¬¢ä½ çš„æˆç†Ÿï¼Œå–œæ¬¢ä½ çš„çŸ¥æ€§ï¼Œå–œæ¬¢ä½ ç…§é¡¾äººçš„æ ·å­ã€‚<br/>
            ä¹Ÿå–œæ¬¢ä½ å¶å°”å› ä¸ºä¸€æ¡æ²¡æ´—çš„è£¤å­è€Œâ€œå¿ƒé‡Œä¸èˆ’æœâ€çš„å¯çˆ±ã€‚</p>

            <p>è¿™ä¸€å¹´ï¼Œæˆ‘ä¸ä¼šæ€¥ï¼Œä¹Ÿä¸ä¼šç»™ä½ å‹åŠ›ã€‚<br/>
            æˆ‘åªæ˜¯å¸Œæœ›ï¼Œåœ¨æ—¶é—´é‡Œï¼Œæˆ‘ä»¬éƒ½èƒ½è¶Šæ¥è¶Šç¡®å®šã€‚</p>

            <p>æƒ…äººèŠ‚å¿«ä¹ã€‚<br/>
            ä¸è®ºè·ç¦»å¤šè¿œï¼Œæˆ‘éƒ½å¾ˆçæƒœå’Œä½ å¹¶è‚©çš„æ„Ÿè§‰ã€‚</p>

            <div class="signature">
              <div>
                <div>â€”â€” <span class="sig-name">ç¥</span></div>
                <div style="opacity:.85;margin-top:6px" id="signedDate"></div>
              </div>
              <div style="opacity:.75">â¤</div>
            </div>
          </section>

          <div class="actions">
            <span class="audio-pill" id="audioStatus">ğŸµ <b>éŸ³ä¹</b>ï¼šå‡†å¤‡æ’­æ”¾â€¦</span>
            <button class="primary" id="playMusic">æ’­æ”¾éŸ³ä¹</button>
            <button id="toggleHearts">å¼€å¯/å…³é—­é£˜è½çˆ±å¿ƒ</button>
            <button id="copyText">å¤åˆ¶æ–‡å­—</button>
            <button id="print">æ‰“å° / ä¿å­˜ä¸ºPDF</button>
          </div>
        </main>

        <footer>
          å°æç¤ºï¼šä½ å¯ä»¥æŠŠè¿™ä¸€é¡µå‘ç»™å¥¹æ‰“å¼€ï¼›æˆ–åœ¨æµè§ˆå™¨é‡Œâ€œæ‰“å° â†’ ä¿å­˜ä¸º PDFâ€ï¼Œå½“ä½œä¸€ä»½å¯ä»¥æ”¶è—çš„ç¤¼ç‰©ã€‚
        </footer>
      </article>
    </div>
  </div>

  <!-- Background music -->
  <audio id="bgm" src="music.mp3" preload="auto" loop></audio>

  <script>
    // ===== Date =====
    (function setDates(){
      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const y = now.getFullYear();
      const m = pad(now.getMonth()+1);
      const d = pad(now.getDate());
      const hh = pad(now.getHours());
      const mm = pad(now.getMinutes());

      document.getElementById('signedDate').textContent = `${y}-${m}-${d}  ${hh}:${mm}`;
      document.getElementById('handDate').textContent = `${y}.${m}.${d}`;
    })();

    // ===== Hearts =====
    const heartsWrap = document.getElementById('hearts');
    let heartsOn = true;
    let heartTimer = null;
    function random(min, max){ return Math.random()*(max-min)+min; }
    function spawnHeart(){
      const h = document.createElement('div');
      h.className = 'heart';
      const left = random(0, 100);
      const size = random(10, 18);
      const duration = random(6, 12);
      const delay = random(0, 0.5);
      h.style.left = left + 'vw';
      h.style.bottom = '-20px';
      h.style.width = size + 'px';
      h.style.height = size + 'px';
      h.style.animationDuration = duration + 's';
      h.style.animationDelay = delay + 's';
      const palette = [
        'rgba(255,107,154,.65)',
        'rgba(255,209,220,.55)',
        'rgba(255,150,190,.55)',
        'rgba(255,120,160,.50)'
      ];
      h.style.background = palette[Math.floor(Math.random()*palette.length)];
      heartsWrap.appendChild(h);
      const removeAfter = (duration + delay + 0.2) * 1000;
      setTimeout(() => h.remove(), removeAfter);
    }
    function startHearts(){
      if (heartTimer) return;
      heartTimer = setInterval(() => {
        spawnHeart();
        if (Math.random() > 0.65) spawnHeart();
      }, 650);
    }
    function stopHearts(){
      clearInterval(heartTimer);
      heartTimer = null;
      [...heartsWrap.children].forEach((c,i)=> setTimeout(()=>c.remove(), i*40));
    }
    startHearts();
    document.getElementById('toggleHearts').addEventListener('click', () => {
      heartsOn = !heartsOn;
      heartsOn ? startHearts() : stopHearts();
    });

    // ===== Copy & Print =====
    document.getElementById('copyText').addEventListener('click', async () => {
      const text = document.getElementById('letter').innerText.trim();
      try{
        await navigator.clipboard.writeText(text);
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
      }
    });
    document.getElementById('print').addEventListener('click', () => window.print());

    // ===== Music with fade in/out =====
    const bgm = document.getElementById('bgm');
    const playBtn = document.getElementById('playMusic');
    const audioStatus = document.getElementById('audioStatus');

    function setAudioStatus(text){ audioStatus.textContent = text; }

    function fadeTo(targetVolume, ms){
      const start = bgm.volume;
      const startTime = performance.now();
      return new Promise(resolve => {
        function step(t){
          const p = Math.min(1, (t - startTime) / ms);
          bgm.volume = start + (targetVolume - start) * p;
          if (p < 1) requestAnimationFrame(step);
          else resolve();
        }
        requestAnimationFrame(step);
      });
    }

    async function playWithFadeIn(){
      try{
        bgm.volume = 0.0;
        await bgm.play();
        setAudioStatus('ğŸµ éŸ³ä¹ï¼šæ­£åœ¨æ’­æ”¾');
        playBtn.textContent = 'æš‚åœéŸ³ä¹';
        await fadeTo(0.55, 1800); // gentle fade-in
      }catch(err){
        setAudioStatus('ğŸµ éŸ³ä¹ï¼šéœ€è¦ç‚¹ä¸€ä¸‹â€œæ’­æ”¾éŸ³ä¹â€');
        playBtn.textContent = 'æ’­æ”¾éŸ³ä¹';
        throw err;
      }
    }

    async function pauseWithFadeOut(){
      try{
        await fadeTo(0.0, 900);
      } finally{
        bgm.pause();
        setAudioStatus('ğŸµ éŸ³ä¹ï¼šå·²æš‚åœ');
        playBtn.textContent = 'æ’­æ”¾éŸ³ä¹';
      }
    }

    playBtn.addEventListener('click', async () => {
      if (!bgm.paused){
        await pauseWithFadeOut();
        return;
      }
      await playWithFadeIn();
    });

    // arm first gesture
    function armFirstGesture(){
      const handler = () => {
        if (bgm.paused) playWithFadeIn().catch(()=>{});
        window.removeEventListener('pointerdown', handler);
        window.removeEventListener('keydown', handler);
      };
      window.addEventListener('pointerdown', handler, { once:true });
      window.addEventListener('keydown', handler, { once:true });
    }
    armFirstGesture();

    // ===== Envelope open sequence =====
    const envelopeWrap = document.getElementById('envelopeWrap');
    const envelope = document.getElementById('envelope');
    const card = document.getElementById('card');
    const hint = document.getElementById('hint');

    let opened = false;

    function setState(cls){
      envelope.classList.remove('state-flap','state-pull','state-unfold');
      envelope.classList.add(cls);
    }

    async function openSequence(){
      if (opened) return;
      opened = true;

      // Try play (gesture)
      playWithFadeIn().catch(()=>{});

      // 1) Open flap
      setState('state-flap');

      // 2) Pull paper out
      setTimeout(() => setState('state-pull'), 650);

      // 3) Unfold into full paper
      setTimeout(() => setState('state-unfold'), 1450);

      // 4) Reveal letter card
      setTimeout(() => {
        card.classList.add('show');
        hint.style.opacity = 0;
        hint.style.transform = 'translateY(-6px)';
        card.scrollIntoView({ behavior:'smooth', block:'start' });
      }, 2200);
    }

    envelopeWrap.addEventListener('click', openSequence);
    envelopeWrap.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') openSequence();
    });
  </script>
</body>
</html>
